
<slot>
	<input ref:input type="date" class="{class}" placeholder="{placeholder}" />
</slot>

<script>
	import flatpickr from 'flatpickr';

	const hooks = new Set([
		'onChange',
		'onOpen',
		'onClose',
		'onMonthChange',
		'onYearChange',
		'onReady',
		'onValueUpdate',
		'onDayCreate'
	]);

	export default {
		data() {
			return {
				element: null,
				placeholder: '',
				value: null,
				class: null,
				options: {}
			};
		},

		oncreate() {
			const { options, element } = this.get()
			const elem = element || this.refs.input
			this.fp = flatpickr(elem, {
				...element ? { wrap: true } : {},
				...this.addHooks(options)
			});
		},

		onupdate({ changed, current, previous }) {
			if (changed.hasOwnProperty('options')) {
				const { options } = current
				this.set({ options: this.addHooks(options) });

				for (let key in Object.keys(options)) {
					this.fp.set(key, options[key]);
				}
			}

			if (changed.hasOwnProperty('value')) {
				const value = current.value
				const oldValue = previous && previous.value
				if (value !== oldValue) {
					this.fp.setDate(value)
				}
			}
		},

		methods: {
			addHooks(options) {
				options = Object.assign({}, options);

				for (let hook of hooks) {
					let firer = (selectedDates, dateStr, instance) => {
						this.fire(stripOn(hook), [selectedDates, dateStr, instance]);
					};

					if (hook in options) {
						// Hooks must be arrays
						if (!Array.isArray(options[hook]))
							options[hook] = [options[hook]];

						options[hook].push(firer);
					} else {
						options[hook] = [firer];
					}
				}

				if (options.onChange && !options.onChange.includes(this.updateValue))
					options.onChange.push(this.updateValue);

				return options;
			},

			updateValue (value) {
				if (Array.isArray(value) && value.length === 1)
					value = value[0];

				this.set({value});
			}
		},

		ondestroy() {
			if (this.fp && 'destroy' in this.fp)
				this.fp.destroy();
		}
	};

	function stripOn(hook) {
		return hook.charAt(2).toLowerCase() + hook.substring(3);
	};
</script>
